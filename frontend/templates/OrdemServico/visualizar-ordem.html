{% extends "default.html" %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
    }
    .info-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .route-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block conteudo %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><span class="material-symbols-outlined me-2">route</span>Visualizar Rota - Ordem #{{ ordem.id if ordem else 'N/A' }}</h2>
        <div class="d-flex gap-2">
            {% if session.funcionario.is_admin %}
            <button class="btn btn-outline-danger d-flex" 
                    data-bs-toggle="modal" 
                    data-bs-target="#modalExcluirOrdem"
                    title="Excluir Ordem">
                <span class="material-symbols-outlined me-1">delete</span>
                Excluir
            </button>
            {% endif %}
            <a href="/ordens-servico" class="btn btn-secondary d-flex">
                <span class="material-symbols-outlined me-1">arrow_back</span>Voltar
            </a>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% else %}
    <div class="row">
        <!-- Informações da Ordem -->
        <div class="col-lg-4">
            <div class="route-info">
                <h5><span class="material-symbols-outlined me-2">assignment</span>{{ ordem.titulo }}</h5>
                <p class="mb-2"><strong>Status:</strong> 
                    {% if ordem.status == 'pendente' %}
                        <span class="badge bg-warning">Pendente</span>
                    {% elif ordem.status == 'em_andamento' %}
                        <span class="badge bg-info">Em Andamento</span>
                    {% elif ordem.status == 'concluida' %}
                        <span class="badge bg-success">Concluída</span>
                    {% else %}
                        <span class="badge bg-danger">Cancelada</span>
                    {% endif %}
                </p>
                <p class="mb-1"><strong>Criado em:</strong> {{ ordem.data_criacao[:10] }}</p>
                {% if ordem.descricao %}
                <p class="mb-0"><strong>Descrição:</strong> {{ ordem.descricao }}</p>
                {% endif %}
            </div>

            <div class="info-card">
                <h6><span class="material-symbols-outlined me-1">directions_car</span>Veículo</h6>
                <p class="mb-1"><strong>Tipo:</strong> {{ ordem.veiculo.tipo }}</p>
                <p class="mb-1"><strong>Placa:</strong> {{ ordem.veiculo.placa }}</p>
                <p class="mb-0"><strong>Capacidade:</strong> {{ ordem.veiculo.capacidade }} pessoas</p>
            </div>

            <div class="info-card">
                <h6><span class="material-symbols-outlined me-1">location_on</span>Destino Final</h6>
                <p class="mb-1"><strong>Obra:</strong> {{ ordem.obra_destino.nome }}</p>
                <p class="mb-0">{{ ordem.obra_destino.rua }}, {{ ordem.obra_destino.numero }} - {{ ordem.obra_destino.bairro }}, {{ ordem.obra_destino.cidade }}</p>
            </div>

            {% if ordem.alojamentos_paradas %}
            <div class="info-card">
                <h6><span class="material-symbols-outlined me-1">hotel</span>Paradas Intermediárias</h6>
                {% for parada in ordem.alojamentos_paradas %}
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-primary me-2">{{ parada.ordem_parada }}</span>
                    <div>
                        <strong>{{ parada.alojamento.nome }}</strong><br>
                        <small class="text-muted">{{ parada.alojamento.cidade }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="info-card" id="route-summary" style="display: none;">
                <h6><span class="material-symbols-outlined me-1">analytics</span>Resumo da Rota</h6>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-primary mb-0" id="distance-display">-</h4>
                            <small class="text-muted">Distância</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-success mb-0" id="duration-display">-</h4>
                            <small class="text-muted">Tempo Est.</small>
                        </div>
                    </div>
                </div>
            </div>

            {% if ordem.observacoes %}
            <div class="info-card">
                <h6><span class="material-symbols-outlined me-1">notes</span>Observações</h6>
                <p class="mb-0">{{ ordem.observacoes }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Mapa -->
        <div class="col-lg-8">
            <div class="position-relative">
                <div id="loading-overlay" class="loading-overlay">
                    <div class="text-center">
                        <div class="spinner"></div>
                        <p class="mt-3">Calculando rota otimizada...</p>
                    </div>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-polyline/1.2.0/polyline.min.js" 
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if ordem %}
    const ordemId = {{ ordem.id }};
    
    // Inicializar o mapa
    const map = L.map('map').setView([-29.7, -51.2], 9);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    function addMarker(latlng, text, color = 'blue', icon = 'location_on') {
        const marker = L.marker(latlng).addTo(map);
        marker.bindPopup(`
            <div class="text-center">
                <span class="material-symbols-outlined text-${color}" style="font-size: 24px;">${icon}</span>
                <h6 class="mt-2 mb-0">${text}</h6>
            </div>
        `);
        return marker;
    }

    async function carregarRota() {
        try {
            console.log('Carregando rota para ordem:', ordemId);
            const response = await fetch(`/api/ordens-servico/${ordemId}/rota`);
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erro na resposta:', errorText);
                throw new Error(`Falha ao carregar dados da rota: ${response.status} - ${errorText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const responseText = await response.text();
                console.error('Resposta não é JSON:', responseText);
                throw new Error('Resposta não é um JSON válido');
            }
            
            const rotaData = await response.json();
            console.log('Dados da rota:', rotaData);
            
            // Adicionar marcadores
            const startPoint = rotaData.veiculo.posicao;
            addMarker([startPoint[1], startPoint[0]], 
                     `INÍCIO - ${rotaData.veiculo.tipo} ${rotaData.veiculo.placa}`, 
                     'success', 'play_arrow');
            
            // Alojamentos (paradas)
            rotaData.alojamentos.forEach((alojamento, index) => {
                const pos = alojamento.posicao;
                addMarker([pos[1], pos[0]], 
                         `PARADA ${alojamento.ordem} - ${alojamento.nome}`, 
                         'warning', 'hotel');
            });
            
            // Destino final
            const endPoint = rotaData.obra_destino.posicao;
            addMarker([endPoint[1], endPoint[0]], 
                     `DESTINO - ${rotaData.obra_destino.nome}`, 
                     'danger', 'flag');
            
            // Calcular e exibir rota
            await calcularRota(rotaData);
            
        } catch (error) {
            console.error('Erro ao carregar rota:', error);
            document.getElementById('loading-overlay').innerHTML = `
                <div class="text-center text-danger">
                    <span class="material-symbols-outlined" style="font-size: 48px;">error</span>
                    <p class="mt-3">Erro ao carregar a rota</p>
                    <p class="text-muted">${error.message}</p>
                </div>
            `;
        }
    }

    async function calcularRota(rotaData) {
        const apiKey = '5b3ce3597851110001cf62489715e0567dc24edd98bd95aee36637a9';
        
        // Preparar coordenadas para a rota
        const coordinates = [];
        coordinates.push(rotaData.veiculo.posicao);
        
        // Adicionar alojamentos ordenados
        rotaData.alojamentos
            .sort((a, b) => a.ordem - b.ordem)
            .forEach(alojamento => {
                coordinates.push(alojamento.posicao);
            });
        
        coordinates.push(rotaData.obra_destino.posicao);
        
        console.log('Coordenadas para rota:', coordinates);
        
        try {
            const directionsResponse = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/json', {
                method: 'POST',
                headers: {
                    'Authorization': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    coordinates: coordinates,
                    profile: 'driving-car',
                    format: 'json',
                    geometry: 'true',
                    instructions: 'false'
                })
            });

            if (!directionsResponse.ok) {
                throw new Error(`Erro na API: ${directionsResponse.statusText}`);
            }

            const directionsData = await directionsResponse.json();
            console.log('Resposta da API:', directionsData);

            if (directionsData.routes && directionsData.routes.length > 0) {
                const route = directionsData.routes[0];
                const summary = route.summary;
                const geometry = route.geometry;

                // Decodificar e exibir a rota
                if (geometry) {
                    const decodedPath = polyline.decode(geometry);
                    
                    const routePolyline = L.polyline(decodedPath, {
                        color: '#3498db',
                        weight: 5,
                        opacity: 0.8
                    }).addTo(map);

                    map.fitBounds(routePolyline.getBounds(), { padding: [20, 20] });
                }

                // Exibir resumo
                if (summary) {
                    const distanceKm = (summary.distance / 1000).toFixed(1);
                    const durationHours = Math.floor(summary.duration / 3600);
                    const durationMinutes = Math.floor((summary.duration % 3600) / 60);
                    
                    document.getElementById('distance-display').textContent = `${distanceKm} km`;
                    document.getElementById('duration-display').textContent = 
                        durationHours > 0 ? `${durationHours}h ${durationMinutes}min` : `${durationMinutes}min`;
                    
                    document.getElementById('route-summary').style.display = 'block';
                }
            }
            
        } catch (error) {
            console.error('Erro ao calcular rota:', error);
            // Ainda assim remover o loading
        }
        
        // Remover overlay de loading
        document.getElementById('loading-overlay').style.display = 'none';
    }

    // Iniciar carregamento da rota
    carregarRota();
    {% endif %}
});
</script>

<!-- Modal de confirmação para exclusão - apenas para admins -->
{% if session.funcionario.is_admin %}
<div class="modal fade" id="modalExcluirOrdem" tabindex="-1" aria-labelledby="modalExcluirOrdemLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalExcluirOrdemLabel">
                    <span class="material-symbols-outlined me-2 text-danger">warning</span>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir esta ordem de serviço?</p>
                {% if ordem %}
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">{{ ordem.titulo }}</h6>
                        <p class="card-text">
                            <strong>ID:</strong> #{{ ordem.id }}<br>
                            <strong>Veículo:</strong> {{ ordem.veiculo.tipo }} - {{ ordem.veiculo.placa }}<br>
                            <strong>Destino:</strong> {{ ordem.obra_destino.nome }}
                        </p>
                    </div>
                </div>
                {% endif %}
                <div class="alert alert-warning mt-3">
                    <span class="material-symbols-outlined me-2">info</span>
                    <strong>Atenção:</strong> Esta ação não pode ser desfeita! Todos os dados da ordem serão permanentemente removidos.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary d-flex" data-bs-dismiss="modal">
                    <span class="material-symbols-outlined me-1">cancel</span>
                    Cancelar
                </button>
                {% if ordem %}
                <form action="/ordens-servico/excluir/{{ ordem.id }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger d-flex">
                        <span class="material-symbols-outlined me-1">delete</span>
                        Excluir Ordem
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
    </div>
</div>

{% endblock %}
