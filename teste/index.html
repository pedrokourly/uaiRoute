<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota Otimizada com OpenRouteService e Leaflet</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        #route-info {
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>

<body>
    <h1>Problema do Caixeiro Viajante com Leaflet</h1>
    <p>Calculando a melhor rota entre Porto Alegre, Gramado e paradas intermediárias.</p>
    <div id="route-info"></div> <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-polyline/1.2.0/polyline.min.js" 
     crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        const apiKey = '5b3ce3597851110001cf62489715e0567dc24edd98bd95aee36637a9'; // Sua chave de API da OpenRouteService

        const map = L.map('map').setView([-29.7, -51.2], 9);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        function addMarker(latlng, text, color = 'blue') {
            const marker = L.marker(latlng).addTo(map);
            marker.bindPopup(text).openPopup();
            return marker;
        }

        async function getOptimizedRoute() {
            const startPoint = [-51.2177, -30.0346]; // Porto Alegre (Início)
            const endPoint = [-50.8764, -29.3794];   // Gramado (Fim)
            const waypoints = [
                [-51.1794, -29.1687], // Caxias do Sul
                [-51.1378, -29.6854], // Novo Hamburgo
                [-50.8497, -29.3653]  // Canela
            ];

            addMarker([startPoint[1], startPoint[0]], 'Ponto de Partida', 'green');
            waypoints.forEach((point, index) => {
                addMarker([point[1], point[0]], `Parada ${index + 1}`, 'orange');
            });
            addMarker([endPoint[1], endPoint[0]], 'Ponto Final', 'red');

            const optimizationRequestBody = {
                jobs: waypoints.map((point, index) => ({
                    id: index + 1,
                    location: point
                })),
                vehicles: [{
                    id: 1,
                    profile: 'driving-car',
                    start: startPoint,
                    end: endPoint
                }],
            };

            try {
                const optResponse = await fetch('https://api.openrouteservice.org/optimization', {
                    method: 'POST',
                    headers: {
                        'Authorization': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(optimizationRequestBody)
                });

                if (!optResponse.ok) {
                    const errorData = await optResponse.json();
                    throw new Error(`Erro na API de Otimização: ${optResponse.statusText} - ${JSON.stringify(errorData)}`);
                }

                const optData = await optResponse.json();
                console.log("Resposta de Otimização:", optData);

                if (optData.routes && optData.routes.length > 0) {
                    const optimizedRouteData = optData.routes[0];
                    console.log("Ordem otimizada das paradas:");

                    const orderedCoordinates = [];
                    orderedCoordinates.push(startPoint);

                    optimizedRouteData.steps.forEach(step => {
                        if (step.type === 'job' || step.type === 'end') {
                            orderedCoordinates.push(step.location);
                        }
                        const coords = [step.location[1], step.location[0]];
                        console.log(`- ${step.type}: ${step.name || `Ponto ${step.id || ''}`} em [${coords.join(', ')}]`);
                    });

                    const lastStepIsEnd = optimizedRouteData.steps[optimizedRouteData.steps.length - 1]?.type === 'end';
                    if (!lastStepIsEnd && !orderedCoordinates.some(coord => coord[0] === endPoint[0] && coord[1] === endPoint[1])) {
                         orderedCoordinates.push(endPoint);
                    }
                    
                    const uniqueOrderedCoordinates = Array.from(new Set(orderedCoordinates.map(JSON.stringify))).map(JSON.parse);

                    console.log("Coordenadas na ordem para a rota detalhada:", uniqueOrderedCoordinates);

                    const directionsRequestBody = {
                        coordinates: uniqueOrderedCoordinates,
                        profile: 'driving-car',
                        format: 'json',
                        geometry: 'true',
                        instructions: 'false'
                    };

                    const directionsResponse = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/json', {
                        method: 'POST',
                        headers: {
                            'Authorization': apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(directionsRequestBody)
                    });

                    if (!directionsResponse.ok) {
                        const errorData = await directionsResponse.json();
                        throw new Error(`Erro na API de Direções: ${directionsResponse.statusText} - ${JSON.stringify(errorData)}`);
                    }

                    const directionsData = await directionsResponse.json();
                    console.log("Resposta de Direções (com geometria):", directionsData);

                    if (directionsData.routes && directionsData.routes.length > 0) {
                        const routeSummary = directionsData.routes[0].summary; // Extrai o resumo da rota
                        const routeGeometry = directionsData.routes[0].geometry;

                        if (routeGeometry) {
                            const decodedPath = polyline.decode(routeGeometry);
                            console.log("Caminho decodificado:", decodedPath);

                            const routePolyline = L.polyline(decodedPath, {
                                color: 'blue',
                                weight: 5,
                                opacity: 0.7
                            }).addTo(map);

                            map.fitBounds(routePolyline.getBounds());

                            // --- EXIBIR DURAÇÃO E DISTÂNCIA AQUI ---
                            if (routeSummary) {
                                const durationSeconds = routeSummary.duration; // Duração em segundos
                                const distanceMeters = routeSummary.distance; // Distância em metros

                                const durationHours = Math.floor(durationSeconds / 3600);
                                const durationMinutes = Math.floor((durationSeconds % 3600) / 60);

                                const distanceKm = (distanceMeters / 1000).toFixed(2); // Distância em km

                                const infoDiv = document.getElementById('route-info');
                                infoDiv.innerHTML = `
                                    <p>Duração Estimada: <strong>${durationHours}h ${durationMinutes}min</strong></p>
                                    <p>Distância Estimada: <strong>${distanceKm} km</strong></p>
                                `;
                            } else {
                                console.warn("Resumo da rota não encontrado.");
                            }
                            // --- FIM EXIBIR DURAÇÃO E DISTÂNCIA ---

                        } else {
                            console.warn("A geometria não foi encontrada na resposta das direções.");
                        }

                    } else {
                        console.warn("Nenhuma rota detalhada foi retornada pelas direções.");
                    }

                } else {
                    console.warn("Nenhuma rota otimizada foi retornada da primeira requisição.");
                }

            } catch (error) {
                console.error('Falha geral ao buscar a rota:', error);
            }
        }

        getOptimizedRoute();
    </script>
</body>

</html>